# Security Development Lifecycle

## 课程简介

软件项目安全开发生命周期

## 实验目录

* [x] 实现XSS攻击
* [x] 静态网页 & 动态网页
* [x] 缓冲区溢出观察实验
* [x] 漏洞利用实验
* [x] 多线程实验 
* [x] 进程和模块
* [ ] WinDBG（可选）
* [x] dll injection
* [ ] 线程注入技术和IAT HOOK综合运用，实现对系统中进程的修改

## 软件安全和漏洞挖掘基础能力

**自己检查自己能力的标准（知道文章里说的是什么）**

### 源代码、可执行程序、编译链接和运行

* 会msvc平台编译链接器的使用：在Windows下编译C\CPP代码为可执行文件（exe）文件
* 会在msvc命令行环境下使用cl.exe和link.exe编译链接生成可执行文件，包括多源代码工程的编译和链接。
* 清楚visual studio c\c++工程中，工程属性和编译器链接器属性的对应关系
* 会查阅编译链接器选项相关文档，并知道常用的编译链接选项。
* 会gcc\clang平台编译连接器的使用：在Linux下编译C\CPP为可执行文件。
* 链接的基本原理：拼接多个程序片段为一个可执行程序，编写自行编译的文件（编译得到中间对象obj或o文件）和程序库文件（lib或者a文件）
* 会使用make(nmake)，会编写makefile **(未讲)**
* 在Windows下使用CreateProcess函数创建进程。**(未讲)**
* 在Linux下使用fork函数创建进程。
* 清楚命令行参数和main函数参数关系。
* 使用命令遍历进程（Windows、Linux）。
* 编程实现Windows下使用API遍历进程。

### 调试和调试器

#### visual studio

* 在visual studio中启动调试器
* 会下断点、删除断点、单步运行、查看运行过程中变量的值。
* 会在调试模式下查看反汇编、内存、寄存器、函数调用栈
* 清楚pdb文件的作用
* 会编译链接生成带有符号文件的调试版本可执行程序
* 会编译链接完全不带符号文件和调试信息的release版本可执行文件
* 能进行程序的优化编译
* Big Endian 和 Little Endian

#### windbg

* 载入程序调试
* 附加到在运行的进程
* 会使用windbg捕获异常
* 设置符号文件服务器和缓存路径
* 会使用命令下断点（bp等）、查看断点（bl）、删除断点（bd\bc）、单步运行（t）、查看运行过程中变量的值(d)、断点命中后恢复程序运行（g）
* 会使用命令查看反汇编、内存值、寄存器值、函数调用栈
* 会使用设置符号文件路径、重载符号文件、源码文件路径pdb文件在windbg下进
* 会查看当前加载的模块列表
* 会设置断点命中后自动运行命令
* 监测API调用，并能获得API调用时的参数值

#### gdb

* 在gdb下能完成和windbg中相同或类似的操作

### 清楚软件的基本运行原理

* 知道什么是CPU什么是内存
* 进行反汇编模式下汇编指令的单步运行、观察运行过程中寄存器的变化
* 知道程序必须载入内存才能运行
* 知道eip寄存器的作用。查看eip指向的内存、在反汇编时显示二进制字节码。
* 变量定义即声明占用内存，用于保存数据。
* 清楚内存地址即指针，内存地址又可存入内存，指针变量及保存内存地址的变量。
* 清楚源代码、汇编和二进制指令的关系
* x86（win32）调试模式下观察push、pop指令运行和栈指针（esp）的关系
* x64的寄存器和指针

### 线程、多线程和线程同步

* Windows下使用CreateThread创建线程
* Linux下使用pthread创建线程
* 线程的并发执行原理
* 使用SuspendThread、ResumeThread API启动和停止线程
* Windows下主线程等待子线程结束（WaitForSingleObject、WaitForMultipleObjects）
* 使用事件（Event）、互斥量（Mutex）进行线程同步。

### 内存管理

* 以4MB（页）作为基本管理单元的虚拟内存管理。
* 虚拟内存管理是一套虚拟地址和物理地址对应的机制。
* 程序访问的内存都是虚拟内存地址，由CPU自动根据系统内核区中的地址对应关系表（分页表）来进行虚拟内存和物理内存地址的对应。
* 每个进程都有一个分页表。
* 每个进程都有一个完整的虚拟内存地址空间，x86情况下为4GB（0x00000000-0xffffffff）
* 但不是每个地址都可以使用（虚拟内存地址没有对应的物理内存）
* 使用VirtualAlloc API可以分配虚拟内存（以页为单位）、使用VirtualFree释放内存分页。
* 使用VirtualProtect 修改内存也保护属性（可读可写可执行）
* 数据执行保护（DEP）的基本原理
* malloc和free等C函数（也包括HeapAlloc和HeapFree等）管理的是堆内存，堆内存区只是全部内存区的一个部分。
* 堆内存管理是建立在虚拟内存管理的机制上的二次分配。
* 真正的地址有效还是无效是以分页为单位的。
* 内存分页可以直接映射到磁盘文件（FileMapping）、系统内核有内存分页是映射物理内存还是映射磁盘文件的内存交换机制。
* 完成内存分页管理的相关实验

### 可执行程序结构和高级编译

#### 了解可执行程序结构、会使用一些基本的解构工具

* PE头
* 清楚PE头中的每个字段的作用、尤其是AddressOfEntryPoint、ImageBase 等重要字段的作用。
* 会使用二进制编辑器查看可执行文件、并找出文件头对应字段
* 会使用dumpbin、objdump和PE explore查看可执行文件结构
* 节表和节、节的内存保护属性
* 导入表和导出表
* ELF文件结构

#### 编译选项对可执行程序结构的影响

* 如何设置固定\随机基地址
* 强制设定入口函数
* mvscrt动态、静态链接
* 启动\关闭栈保护
* 启动\关闭c\cpp异常捕获
* 启动\关闭数据执行保护
* 引入程序库（lib）文件的方法，缺少Lib文件时链接的报错及解决方法。

### 动态链接

* Windows下编译链接生成dll文件并导出函数
* Linux下编译链接so文件并导出函数
* Dll文件的导入库lib文件
* 在exe文件中调用自编译的动态链接导出函数
* 查看可执行文件中的导入表和导出表
* 动态链接的基本原理，程序加载时的动态链接过程
* LoadLibrary和GetProcAddress API
* 动态链接相比静态链接的优点：底层库的升级不会引起所有依赖于此库的程序升级、硬盘和内存占用小等。

### 指令集

* 查阅x86\x64指令集官方文档
* 查阅arm指令集官方文档
* 查阅mips指令集官方文档

### 实际执行与虚拟执行

* 理解执行。程序：需要做的事情，执行器：做事情的，执行：做事情；指令指针寄存器：执行器记录当前执行到哪里了。
* 二进制程序与脚本程序、实际执行与虚拟执行
* 理解编译执行和解释执行两种情况，Java和.net是特例
* 脚本程序的执行器是一个二进制程序。
* 脚本程序无需编译，执行器可理解源码。
* CPU只能理解二进制指令、指令集相对固定是降低芯片设计复杂度的需要。

### 程序语言的进化

* 汇编：使用容易记忆的文本符号进行编程。链接器自动完成程序和内存地址的拼接。
* C：使用接近于人的逻辑思维编程，函数的划分，源代码需要编译为机器指令才能运行，任然需要直接操作内存。
* CPP：面向对象、有更丰富的基础库
* Java和.Net
* PHP、python和JavaScript
* golang
* 注意：语言、工具和操作系统甚至硬件是相互促进循环发展的。先用机器指令开发了最简单的系统和最简单的编程工具，再逐步构建更复杂的系统。

### 逆向工程基本原理

* 会使用二进制文件结构工具和反汇编器（objdump、dumpbin）、和调试器（windbg等）
* 会进行反汇编实验、调试模式下反汇编，查看源代码与汇编对应关系
* 理解函数调用栈、ebp栈基地址指针
* 理解函数调用传参的基本原理
* 理解输出参数为什么只能是指针，为什么被调函数内部给参数赋值不能传递给主调函数。
* 知道call指令和ret指令的入栈与出栈操作和入栈的内容
* 知道局部变量的内存空间开辟过程
* 理解stdcall、cdecl和fastcall三种不同函数调用方式的传参方式和栈平衡方式
* 知道eax用于保存函数返回值
* 知道标志位寄存器用于保存数据比较的结果
* 了解jmp无条件跳转指令
* 理解Jcc系列指令与标志位寄存器的配合形成逻辑分支执行流程
* 理解Switch-case与跳转表
* 清楚绘制函数调用关系图的方法，会编程实现或者使用工具（IDA-pro等）绘制函数调用关系图
* 掌握绘制控制流图的方法和工具
* 清楚如何识别循环
* 理解程序执行树
* 清楚堆的分配和释放过程，基于双链表管理。
* 理解栈溢出漏洞
* 理解堆溢出漏洞

### 反逆向工程

* 加壳与脱壳
* 花指令代码混淆
* 控制流代码混淆

### 函数指针和hook

* 理解函数指针和回调
* 理解虚函数和多态的原理
* 理解IAT hook的基本原理，会编程实验IAT hook
* 了解文件浏览器的基本原理（Windows为例FindFirstFile、FindNextFile），编程实现基于IAT hook的文件隐藏
* 通过可执行文件中导入表反应的API调用情况分析实现原理
* 编程实现进程隐藏
* 编程实现通信端口隐藏
* 了解inline hook的基本原理
* 了解SSDK hook的基本原理

### 高级Rootkit技术

* 会编写远程线程注入程序
* 会编写内核驱动程序和内核驱动加载程序
* 硬盘引导扇区和bootkit
* DKOM的基本原理
* windbg内核态调试

### Web软件原理

* 浏览器的功能和作用
* url
* http
* html
* cgi
* 前端脚本：JavaScript
* 后端脚本（程序）：PHP、Python、Java、C\C++等
* Web API和restful架构、Json和xml数据接口
* 数据库在Web后台的作用
* Web框架：Laravel、Flask、Django等
* 前端框架：Bootstrap、Vue.js、AdminLTE等
* 浏览器内核
* JavaScript的执行引擎
* JavaScript向通用软件的转变尝试：Node.js
* 基于web框架的app（electron、Cordova等）

### 常见Web漏洞

* XSS原理
* SQL注入原理

### 编程思想

* 抽象
* 封装
* 复用
* 继承
* 多态
* 框架式编程

### 常见软件实现原理

* 界面：GDI、Directx、通用控件、基于Web框架
* 网络：socket、http
* 常用数据结构和处理：结构体、链表、队列、哈希表、序列化与反序列化
* 本地数据：直接文件访问、日志、本地数据库（数据库链接、SQL）
* 网络数据：html、xml、json
* 常见的数据加密算法：RSA、DES等等

### 软件行为记录与分析、沙箱

* 网络行为获取：抓包器的使用
* 本地行为获取：基于调试器脚本的软件主机行为记录
* 调试器检测、反调试技术
* API调用记录分析
* 单步执行记录分析
* 沙箱的基本原理
* 基于沙箱的软件行为记录

### 漏洞挖掘技术

* 源码和反汇编白盒分析
* 补丁比对
* Fuzzing模糊测试黑盒分析
* 符号执行、约束求解

### 网络安全防御体系

* 漏洞报告与补丁发布、自动升级机制
* 漏洞数据库CVE、NVD、CNVD、CNNVD
* 文件静态特征：hash值或局部hash值
* 病毒数据库和静态特征扫描及其优缺点和应用范围(杀毒软件、IDS和IPS)
* 防火墙的原理、优缺点和应用范围
* HIPS的原理、优缺点和应用范围
* 蜜罐：未知攻击和恶意软件捕获
* 沙箱：可疑样本的行为提取和分析
* 靶场：样本分析平台、攻防演练平台
* 态势感知：综合化的综合情报分析和可视化